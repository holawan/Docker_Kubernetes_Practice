# 클론코딩 - 실제 서비스 구축

## 실제 바로 활용할 수 있는 사이트 작성해보기

- docker compose로 mysql + wordpress를 설치하고,
- nginx reverse proxy로 특정 경로로는 wordpress 서버 연결, 이외 경로는 별도 웹페이지를 구성할 수 있는 내부 nginx 서버로 이동 

#### Docker

- docker-compose.yml 파일 설정
    - nginx reverse proxy 서버를 만들고, nginx.conf 설정 파일로 proxy 설정
    - wordpress는 mysql이 필요하므로, 별도 mysql 서버를 도커로 구축
    - wordpress 도커 구축 

```yaml
version: "3"

services:
  #요청이 들어오면 적절한 위치로 forwading
  nginxproxy:
    depends_on:
      - nginx
      - db
      - wordpress
    image: nginx:latest
    ports:
      - "80:80"
    restart: always
    volumes:
      - "./nginx/nginx.conf:/etc/nginx/nginx.conf"

  nginx:
    image: nginx:latest
    restart: always

  db:
    image: mysql:5.7
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: somewordpress
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress

  wordpress:
    depends_on:
      - db
    image: wordpress:5.7.0
    #테스트를 위한 8080 포트 오픈 
    ports:
      - "8080:80"
    restart: always
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
```

### Nginx

- 현재 폴더에 하부 폴더로 nginx를 만들고, 해당 폴더에 nginx.conf 파일 적상 (즉, ./nginx/nginx.conf 파일 작성)
- 접속 시 워드 프레스 이미지 자체적으로 여러 코드를 실행 시킬 수 있음 
    - 따라서, 여러 포트를 실행시키고, 다른 외부로 요청을 보낼 수 있는데 `/blog` url을 rewrite로 지워버리면 내부 서버에 요청을 보낼 수 있기 때문에, rewrite 금지  
- wordpres 서버 안에 있는 코드들이 기본적으로  `/usr/www/html`로 되어 있다면,앞의 blog가 붙지 않아서 잘못된 경로에서 파일을 찾을 수 있음. 따라서 wordpress 관련 폴더들은 모두 `usr/www/html/blog` 하위로 이동

```nginx
user nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events { 
    worker_connections 1024; 
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" "$request_uri" "$uri"'
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;    
    sendfile on;
    keepalive_timeout 65;

    upstream docker-wordpress {
        server wordpress:80;
    }

    upstream docker-web {
        server nginx:80;
    }

    server {
        location /blog/ {
            #rewrite ^/blog(.*)$ $1 break;
            #접속 시 자체적으로 여러 코드를 실행 시킴 
        	# 따라서, 여러 포트를 실행시키고, 다른 외부로 요청을 보낼 수 있는데 rewrite로 지워버리면 내부 서버에 요청을 보낼 수 있기 때문에, rewrite 금지  
            proxy_pass         http://docker-wordpress;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
        }
        
        location / {
            proxy_pass         http://docker-web;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
        }
    }
}

```

