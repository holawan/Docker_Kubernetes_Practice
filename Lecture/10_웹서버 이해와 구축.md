# 웹서버 이해와 구축

## Apache와 nginx 웹서버 이해

### 웹서버

- 웹서버는 HTTP 요청을 읽어서, 응답을 해주는 프로그램
- 웹서버 프로그램을 서버상에 설치하여, 특정 HTTP 요청에 따라, 서비스를 제공해주는 방식으로 웹서비스를 구현
- 상용으로 많이 쓰이는 웹서버 프로그램은 크게 apache 와 nginx가 있으며, 간략히 두 프로그램일 비교하며 웹서버에 대해 이해함



### Apache vs Nginx

- Apache는 오픈소스 프로젝트로 가장 유명한 프로그램 중 하나
- 수십년간 웹서버 프로그램으로는 Apache 프로그램을 사용하였음 

#### Apache 구동 방식

- Apache는 꾸준히 성능을 개선하고 있으며, 다음과 같이 두 가지 기본적인 방식을 지원함
    - Prefork MPM(Multi Processing Module) 방식
        - HTTP 요청이 올 때마다, 프로세스를 복제하여, 각각 별도 프로세스에서 해당 HTTP 요청 처리
    - Worker MPM (Multi Processing Module) 방식
        - 하나의 HTTP 연결 후, 여러 요청을 처리하기 위해, 복제된 프로세스 내에서 여러 쓰레드를 생성하여, 여러 HTTP 요청을 처리하는 방식 

#### Nginx 구동 방식

- Event Driven 방식

    - 하나의 프로세스로 동작하며, HTTP 요청을 event로 비동기식으로 처리함
        - 대부분의 HTTP 응답은 결국 html 파일을 제공하는 것이므로, IO 작업
        - 따라서, IO 작업으로 event를 포워딩하고, 요청 순이 아닌, 요청 작업이 끝난 순으로 처리함
    - HTTP 요청마다, 프로세스든 쓰레드든 생성이 필요없으므로, 시스템 자원 관리에 장점이 있음
    - 보통 많은 접속자가 있을 경우, 시스템 자원 관리 효율성 때문에, Nginx가 보다 일반적으로는 성능이 좋을 수 있음
        - HTML 파일 사이즈, 어떤 추가 기능을 쓰느냐 등등 다양한 조건 때ㅜㅁㄴ에, 무조건 성능이 좋다고 이야기할 수 없음 

    > 단 웹서버는 다양한 추가 기능과 함게 동작하므로, 종합적인 성능에는 큰 차이를 보이지는 않음
    >
    > (예를 들어, PHP 언어 지원을 위해, Apache와 Nginx는 추가 모듈등이 필요하고, 해당 모듈의 성능도 종합 성능에 영향을 미침)



### Nginx 기본 사용법

> docker를 사용하는 큰 이유 중 하나가, 서버용 프로그램이 버전과, 리눅스 패키지마다, 설정 방법이 매우 다르기 때문임 
>
> 따라서, 본 설정은 참고용 (ubuntu 20.04, nginx 1.18.0 버전 테스트)

```bash
docker run -dit -p 80:8080 --name myos ubuntu:20.04
docker exec -it myos /bin/bash 

apt-get update 
apt-cache policy nginx #추천 버전 확인
apt-get install nginx=1.18.0-0ubuntu1.2 #6.Asia 69. Seoul
apt-get install vim
```

- 다음 작업을 진행한 후, localhost:8080 접속 

```bash
vi sites-avaliable/default 

--------------default 파일 수정 
server {
		listen 8080 default_server; #listen 80을 8080으로 변경 
}
---------------
service nginx restart

```

> 이상의 작업을 완료한 후, 다음 설명을 통해, 세부적인 부분들을 이해

#### nginx.conf

```bash
find -name nginx.conf 
vi /etc/nginx/nginx.conf
```

- nginx 웹 서버 기본 설정 파일

- 크게 user, worker_processes, pid, events,http 항목으로 이루어짐

    - user : 웹서버를 돌리는 유저의 ID가 무엇인가
    - worker_proceses : 프로세서를 몇 개 만들 것인가
    - pid : 시스템과 nginx의 연결고리 설정 
    - include : 설정이 하나만 있는 것이 아니라 캡슐화 되어 있을 수 있으므로, 설정이 있는 다른 파일들을 불러오는 명령
    - events : 하나의 프로세스가 events를 받아서 처리하는 방식이므로, event를 몇개까지 받아서 지원할지
    - http : 

- 이 중에서 http 블록이 전체 웹서버 기본 설정 항목임

    - 참고 : http 블록에서 설정할 수 있는 모든 설정

- http 블록 중 다음 항목으로 다양한 웹서비스를 별도 파일로 설정하는 것이 일반적임

    - /etc/nginx/conf.d**/mysite.com.conf** 형태로 웹서비스별 설정을 별도 파일로 할 수 있음 

    - 관련 파일에는 server 항목 설정 (다음 default 파일의 server 설정에서 상세 내용 확인)

##### 참고 

> nginx를 어덯게 설치하느냐에 따라서, 설정 파일등의 위치가 다를 수 있음
>
> 이 때문에 실수하는 경우가 많음
>
> 예를 들어 ubuntu에서 apt-get으로 설치 시와 nginx 도커로 설치 시 설정 파일 위치등이 다를 수 있음

- ubuntu 등 특정 패키지에서 설치한 nginx에서는 `/etc/nginx/sites-enalbed` 폴더도 include 되어 있을 것임
- 해당 폴더는 `/etc/nginx/sites-available` 폴더의 심볼릭 링크 폴더임
- 즉, `/etc/nginx/sites-available` 폴더에 파일을 작성해놓으면, 자동으로 `/etc/nginx/sites-enabled/`폴더에 넣어진 것으로 보이게 되고, 해당 파일들은 nginx.conf의 http 항목의 include 명령을 통해, 웹서버 설정에 적용됨
- 그렇기 때문에, `/etc/nginx/sites-available/default` 파일 변경 후, nginx 재실행시, 반영이 되는 것임
- 디폴트 웹서비스 설정은 ubuntu 20.04/ nginx 1.18.0의 경우, 
    - `/etc/nginx/sites-available/default`라는 파일에 있음
    - `/etc/nginx/conf.d/mysite.com.conf` 형태로 작성하는 경우도 있지만, ubuntu 20.04 / nginx.1.18.0의 경우에는 default 웹서비스 설정을 하고, 추가 웹서비스가 있다면, 별도로 또 다른 mysite.com 등의 파일을 해당 폴더에 작성하면 됨

```
include /etc/nginx/conf.d/*.conf;
include /etc/nginx/sites-enabled/*;
```

- 심볼릭 링크

```
/etc/nginx/sites-enabled# ls -al
total 8
drwxr-xr-x 2 root root 4096 Oct  3 19:38 .
drwxr-xr-x 8 root root 4096 Oct  3 19:38 ..
lrwxrwxrwx 1 root root   34 Oct  3 19:38 default -> /etc/nginx/sites-available/default
```

#### default 파일의 server 설정

- listen은 HTTP 요청을 받을 포트 설정
- **default_server는 모든 웹서버 요청을 받는다는 의미**
- 두 번째 줄의 listen은 IPv6 포트 관련 설정이므로 무시해도 됨

```
listen 80 default_server;
listen [::]:80 default_server;
```

- server_name은 요청을 받을 도메인 이름 설정
    - localhost나 별도 도메인 이름이 없다면, 기본 설정으로 놔두면 됨(`_`)

```
server_name holawan.org www.holawan.org
```

- location 설정
    - location 기본 설정 이해
        - 웹서버 주소에 따라, 요청되는 파일을 찾는 디폴트 폴더를 root로 설정하고, 
        - location 설정으로 웹서버 주소에 따른 폴더를 변경할 수 있음
        - index는 해당 웹서버 주소 요청시, 디폴트로 응답할 index.html 파일명 설정
            - 예를 들어, PHP 언어를 쓴다면, index.php로 디폴트 파일을 설정하기 위해 설정
- location 설정 테스트 : 하위경로를 설정해 다른 서버로 보내기?

```nginx
vi /etc/nginx/sites-available/default

location /blog {

                root/var/www;
        }

        location /flask {

                root /var/www;
        }

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
```
